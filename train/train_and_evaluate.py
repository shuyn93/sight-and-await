# -*- coding: utf-8 -*-
"""train_and_evaluate.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1SHqID7plggyX8WzPdjnsSR7bLw8cY31u
"""

"""
train_and_evaluate.py
---------------------

Module dÃ¹ng Ä‘á»ƒ:
1. Giáº£i phÃ³ng bá»™ nhá»› GPU.
2. Huáº¥n luyá»‡n mÃ´ hÃ¬nh YOLOv8x-pose báº±ng Ultralytics CLI.
3. Äá»c káº¿t quáº£ training tá»« results.csv vÃ  tÃ¬m epoch tá»‘t nháº¥t (Pose mAP50).
4. ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh best.pt trÃªn táº­p test.

YÃªu cáº§u:
- ÄÃ£ cháº¡y concat_datasets.py hoáº·c giáº£i nÃ©n file zip trong data/image Ä‘á»ƒ táº¡o merged/data.yaml.
- ÄÃ£ cÃ i: ultralytics, torch, pandas, opencv-python.

Cháº¡y:
    python train_and_evaluate.py
"""

from ultralytics import YOLO
import torch
import pandas as pd
import subprocess
import os


def clear_gpu():
    """
    Giáº£i phÃ³ng bá»™ nhá»› GPU Ä‘á»ƒ trÃ¡nh lá»—i CUDA Out Of Memory.
    """
    try:
        torch.cuda.empty_cache()
        print("ğŸ”„ GPU memory cleared.")
    except:
        print("âš ï¸ KhÃ´ng tÃ¬m tháº¥y GPU hoáº·c khÃ´ng thá»ƒ clear cache.")


def run_training(data_path: str, model_path: str):
    """
    Cháº¡y huáº¥n luyá»‡n YOLO báº±ng subprocess.

    Args:
        data_path (str): ÄÆ°á»ng dáº«n Ä‘áº¿n file data.yaml cá»§a YOLO.
        model_path (str): MÃ´ hÃ¬nh pretrain (vd: yolov8x-pose.pt).

    Returns:
        None
    """

    command = [
        "yolo",
        "task=pose",
        "mode=train",
        f"model={model_path}",
        f"data={data_path}",
        "batch=16",
        "epochs=150",
        "imgsz=640",
        "mosaic=0.0",
        "plots=True",
        "lr0=0.001",
        "lrf=0.0001",
        "weight_decay=0.0005",
        "amp=True",
        "resume=True"
    ]

    print("ğŸš€ Báº¯t Ä‘áº§u huáº¥n luyá»‡n YOLOv8x-pose...")
    subprocess.run(" ".join(command), shell=True)
    print("âœ… Huáº¥n luyá»‡n hoÃ n táº¥t!")


def find_best_epoch(csv_path: str) -> pd.Series:
    """
    Äá»c results.csv vÃ  tÃ¬m epoch cÃ³ Pose mAP50 cao nháº¥t.

    Args:
        csv_path (str): ÄÆ°á»ng dáº«n Ä‘áº¿n file results.csv.

    Returns:
        pd.Series: DÃ²ng chá»©a epoch tá»‘t nháº¥t.
    """

    df = pd.read_csv(csv_path)

    # Epoch tá»‘t nháº¥t dá»±a trÃªn metrics/mAP50(P)
    best_epoch = df.loc[df['metrics/mAP50(P)'].idxmax()]
    return best_epoch


def evaluate_model(best_weight_path: str, data_path: str):
    """
    ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh tá»‘t nháº¥t trÃªn test set.

    Args:
        best_weight_path (str): ÄÆ°á»ng dáº«n file best.pt.
        data_path (str): ÄÆ°á»ng dáº«n file data.yaml.

    Returns:
        dict: Chá»‰ sá»‘ Box mAP50 vÃ  Pose mAP50.
    """
    print("ğŸ§ª Äang Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh best.pt...")

    model = YOLO(best_weight_path)
    metrics = model.val(data=data_path, split="test")

    return {
        "box_mAP50": metrics.box.map50,
        "pose_mAP50": metrics.pose.map50
    }


if __name__ == "__main__":
    # ---- 1. Clear GPU ----
    clear_gpu()

    # ---- 2. Cáº¥u hÃ¬nh Ä‘Æ°á»ng dáº«n ----
    DATA_PATH = "datasets/YOLO_Datasets/merged/data.yaml"
    MODEL_PRETRAIN = "yolov8x-pose.pt"

    # ---- 3. Train YOLO ----
    run_training(DATA_PATH, MODEL_PRETRAIN)

    # ---- 4. Äá»c káº¿t quáº£ vÃ  chá»n epoch tá»‘t nháº¥t ----
    results_csv = "./runs/pose/train/results.csv"
    best_epoch = find_best_epoch(results_csv)

    print("\nğŸ† Epoch tá»‘t nháº¥t (chá»n theo Pose mAP50):")
    print(best_epoch)

    # ---- 5. ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh best.pt ----
    BEST_WEIGHT = "./runs/pose/train/weights/best.pt"
    eval_results = evaluate_model(BEST_WEIGHT, DATA_PATH)

    print("\nğŸ“Š Káº¿t quáº£ Ä‘Ã¡nh giÃ¡:")
    print(f"Box mAP50   : {eval_results['box_mAP50']}")
    print(f"Pose mAP50  : {eval_results['pose_mAP50']}")