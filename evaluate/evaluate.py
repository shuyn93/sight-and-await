# -*- coding: utf-8 -*-
"""Untitled7.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1vlkOxKK6ydfx0QxO9WgZCKebKxuiMSfO
"""

"""
EvaluationModels.py
-------------------

Module nÃ y dÃ¹ng Ä‘á»ƒ:
1. Giáº£i nÃ©n dataset (náº¿u cáº§n).
2. Kiá»ƒm tra sá»‘ lÆ°á»£ng file áº£nh/nhÃ£n.
3. Cháº¡y Ä‘Ã¡nh giÃ¡ (evaluation) cho nhiá»u mÃ´ hÃ¬nh YOLO:
   - Player detection model
   - Pitch nano model
   - Pitch small model
   - CÃ¡c pitch models khÃ¡c tÃ¹y vÃ o Ä‘Æ°á»ng dáº«n cung cáº¥p

Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng:
- Load mÃ´ hÃ¬nh
- Cháº¡y model.val() trÃªn táº­p test
- In ra Box mAP50, Box mAP50-95, Pose mAP50, Pose mAP50-95

YÃªu cáº§u:
- ultralytics
- opencv-python
- torch
- pandas
"""

import os
from pathlib import Path
from ultralytics import YOLO
import torch


# ----------------------------------------------------------
# 1. Utility â€“ Ä‘áº¿m file trong thÆ° má»¥c
# ----------------------------------------------------------

def count_files(root_dir: str) -> int:
    """Äáº¿m tá»•ng sá»‘ file trong má»™t thÆ° má»¥c."""
    path = Path(root_dir)
    if not path.exists():
        print(f"âŒ ThÆ° má»¥c khÃ´ng tá»“n táº¡i: {root_dir}")
        return 0
    return sum(1 for p in path.rglob("*") if p.is_file())


def count_jpg(root_dir: str) -> int:
    """Äáº¿m sá»‘ file .jpg hoáº·c .jpeg trong thÆ° má»¥c."""
    path = Path(root_dir)
    if not path.exists():
        print(f"âŒ KhÃ´ng tá»“n táº¡i thÆ° má»¥c: {root_dir}")
        return 0
    return sum(1 for p in path.rglob("*") if p.suffix.lower() in [".jpg", ".jpeg"])


# ----------------------------------------------------------
# 2. Evaluate function â€“ dÃ¹ng chung cho táº¥t cáº£ models
# ----------------------------------------------------------

def evaluate_model(model_path: str, data_yaml: str):
    """
    ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh YOLO trÃªn test set.

    Args:
        model_path (str): Ä‘Æ°á»ng dáº«n tá»›i file .pt
        data_yaml (str): Ä‘Æ°á»ng dáº«n tá»›i file data.yaml

    Returns:
        dict: chá»©a cÃ¡c mAP cá»§a Box vÃ  Pose
    """
    print(f"\n==============================")
    print(f"ğŸ” Äang Ä‘Ã¡nh giÃ¡ model: {model_path}")
    print(f"==============================")

    model = YOLO(model_path)

    metrics = model.val(
        data=data_yaml,
        split="test"
    )

    results = {
        "Box_mAP50": metrics.box.map50,
        "Box_mAP50_95": metrics.box.map,
        "Pose_mAP50": getattr(metrics, "pose", None).map50 if hasattr(metrics, "pose") else None,
        "Pose_mAP50_95": getattr(metrics, "pose", None).map if hasattr(metrics, "pose") else None
    }

    print(f"ğŸ“Œ Box mAP50      : {results['Box_mAP50']}")
    print(f"ğŸ“Œ Box mAP50-95   : {results['Box_mAP50_95']}")
    if results["Pose_mAP50"] is not None:
        print(f"ğŸ“Œ Pose mAP50     : {results['Pose_mAP50']}")
        print(f"ğŸ“Œ Pose mAP50-95  : {results['Pose_mAP50_95']}")

    return results


# ----------------------------------------------------------
# 3. Main â€“ cháº¡y láº§n lÆ°á»£t táº¥t cáº£ evaluations
# ----------------------------------------------------------

def main():
    """
    HÃ m chÃ­nh: kiá»ƒm tra dá»¯ liá»‡u â†’ cháº¡y evaluation cho cÃ¡c models.
    """

    # ==== 1. Kiá»ƒm tra sá»‘ lÆ°á»£ng file (tÆ°Æ¡ng Ä‘Æ°Æ¡ng Cell 31â€“32) ====
    train_folder = "/content/data/datasets/YOLO_Datasets/merged/images/train"
    print("ğŸ“ Sá»‘ file tá»•ng  :", count_files(train_folder))
    print("ğŸ–¼ï¸ Sá»‘ file .jpg :", count_jpg(train_folder))

    # ==== 2. Cáº¥u hÃ¬nh dataset YAML ====
    DATA_YAML = "/content/data/datasets/YOLO_Datasets/merged/data.yaml"

    # ==== 3. Danh sÃ¡ch model cáº§n Ä‘Ã¡nh giÃ¡ ====
    model_paths = [
        "/content/best_pitch_nano.pt",
        "/content/best_pitch_s.pt"
    ]

    # ==== 4. Cháº¡y evaluation tá»«ng mÃ´ hÃ¬nh ====
    for model_path in model_paths:
        if os.path.exists(model_path):
            evaluate_model(model_path, DATA_YAML)
        else:
            print(f"âš ï¸ Model khÃ´ng tá»“n táº¡i: {model_path}")


# ----------------------------------------------------------
if __name__ == "__main__":
    main()